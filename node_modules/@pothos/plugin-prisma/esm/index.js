import './global-types.js';
import './schema-builder.js';
import SchemaBuilder, { BasePlugin } from '@pothos/core';
import { PrismaObjectFieldBuilder as InternalPrismaObjectFieldBuilder } from './field-builder.js';
import { formatPrismaCursor, parsePrismaCursor } from './util/cursors.js';
import { getLoaderMapping, setLoaderMappings } from './util/loader-map.js';
import { queryFromInfo, selectionStateFromInfo } from './util/map-query.js';
export { prismaConnectionHelpers } from './connection-helpers.js';
export { PrismaNodeRef } from './node-ref.js';
export { PrismaObjectRef } from './object-ref.js';
export * from './types.js';
const pluginName = "prisma";
export default pluginName;
export { formatPrismaCursor, parsePrismaCursor, queryFromInfo };
export const ObjectFieldBuilder = InternalPrismaObjectFieldBuilder;
export class PrismaPlugin extends BasePlugin {
    onOutputFieldConfig(fieldConfig) {
        if (fieldConfig.kind === "PrismaObject" && fieldConfig.pothosOptions.select) {
            const { select } = fieldConfig.pothosOptions;
            return {
                ...fieldConfig,
                extensions: {
                    ...fieldConfig.extensions,
                    pothosPrismaSelect: typeof select === "function" ? (args, ctx, nestedQuery) => ({
                        select: select(args, ctx, nestedQuery)
                    }) : select
                }
            };
        }
        return fieldConfig;
    }
    wrapResolve(resolver, fieldConfig) {
        var _fieldConfig_extensions, _fieldConfig_extensions1, _parentConfig_extensions, _fieldConfig_extensions2;
        if (fieldConfig.kind !== "PrismaObject" || !((_fieldConfig_extensions = fieldConfig.extensions) === null || _fieldConfig_extensions === void 0 ? void 0 : _fieldConfig_extensions.pothosPrismaSelect)) {
            return resolver;
        }
        const parentConfig = this.buildCache.getTypeConfig(fieldConfig.parentType, "Object");
        const loadedCheck = (_fieldConfig_extensions1 = fieldConfig.extensions) === null || _fieldConfig_extensions1 === void 0 ? void 0 : _fieldConfig_extensions1.pothosPrismaLoaded;
        const loaderCache = (_parentConfig_extensions = parentConfig.extensions) === null || _parentConfig_extensions === void 0 ? void 0 : _parentConfig_extensions.pothosPrismaLoader;
        const fallback = (_fieldConfig_extensions2 = fieldConfig.extensions) === null || _fieldConfig_extensions2 === void 0 ? void 0 : _fieldConfig_extensions2.pothosPrismaFallback;
        return (parent, args, context, info) => {
            const mapping = getLoaderMapping(context, info.path, info.parentType.name);
            if ((!loadedCheck || loadedCheck(parent)) && mapping) {
                setLoaderMappings(context, info, mapping);
                return resolver(parent, args, context, info);
            }
            if (fallback) {
                return fallback(queryFromInfo({
                    context,
                    info
                }), parent, args, context, info);
            }
            const selectionState = selectionStateFromInfo(context, info);
            return loaderCache(parent).loadSelection(selectionState, context).then((result) => {
                const mappings = selectionState.mappings[info.path.key];
                if (mappings) {
                    setLoaderMappings(context, info, mappings.mappings);
                }
                return resolver(result, args, context, info);
            });
        };
    }
    constructor(cache) {
        super(cache, pluginName);
    }
}
SchemaBuilder.registerPlugin(pluginName, PrismaPlugin);
//# sourceMappingURL=index.js.map
